<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewModel="clr-namespace:MauiTestApp.ViewModels"
             xmlns:dtos="clr-namespace:MauiTestApp.DTOs"
             xmlns:misc="clr-namespace:MauiTestApp.ViewModels.Misc"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             x:Class="MauiTestApp.Views.SearchView"
             x:DataType="viewModel:SearchViewModel">

    <ContentPage.Resources>
        <toolkit:InvertedBoolConverter x:Key="InvertBoolConverter" />
    </ContentPage.Resources>

    <ScrollView>
        <VerticalStackLayout
            Padding="10"
            Spacing="10">
            <SearchBar 
                x:Name="SearchBar"
                Text="{Binding SearchQuery}"
                SearchCommand="{Binding SearchCommand}"
            />


            <Border Stroke="LightGray" Padding="10" HorizontalOptions="Fill">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="5" />
                </Border.StrokeShape>
                <VerticalStackLayout>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <Label 
                            Grid.Column="0"
                            Text="Опции поиска" 
                            IsVisible="{Binding IsFilterExpanded, Converter={StaticResource InvertBoolConverter}}"
                            HorizontalOptions="Start"
                            VerticalOptions="Center"/>
                        <ImageButton
                            Grid.Column="1"
                            IsVisible="{Binding IsFilterExpanded, Converter={StaticResource InvertBoolConverter}}"
                            HorizontalOptions="End"
                            Source="expand_arrow.png"
                            HeightRequest="32"
                            WidthRequest="32"
                            Command="{Binding ToggleFiltersPanel}"
                        />
                        <ImageButton
                            Grid.Column="1"
                            IsVisible="{Binding IsFilterExpanded}"
                            HorizontalOptions="End"
                            Source="expand_arrow.png"
                            HeightRequest="32"
                            WidthRequest="32"
                            ScaleY="-1"
                            Command="{Binding ToggleFiltersPanel}"
                        />
                    </Grid>
                    <VerticalStackLayout IsVisible="{Binding IsFilterExpanded}" Spacing="10">
                        <Picker 
                             x:Name="searchPicker"
                             Title="Искать по"
                             SelectedItem="{Binding CurrentSearchOption}"
                             ItemsSource="{Binding SearchPickerItems}"
                             ItemDisplayBinding="{Binding DisplayName}"
                        />


                        <Border Stroke="LightGray" Padding="10">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="5" />
                            </Border.StrokeShape>
                            <VerticalStackLayout>
                                <Label Text="Жанры:"/>
                                <CollectionView ItemsSource="{Binding GenresFilter}"
                                    SelectionMode="None">
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate x:DataType="misc:SearchGenreSelection">
                                            <HorizontalStackLayout>
                                                <CheckBox IsChecked="{Binding IsSelected}"
                                   Color="#512BD4"/>
                                                <Label Text="{Binding Name}" 
                                VerticalOptions="Center"/>
                                            </HorizontalStackLayout>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>
                            </VerticalStackLayout>
                        </Border>
                    </VerticalStackLayout>
                </VerticalStackLayout>
            </Border>

            <CollectionView ItemsSource="{Binding SearchResults}">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="dtos:FilmEntryDTO">
                        <VerticalStackLayout Padding="10">
                            <Label Text="{Binding Name}" FontSize="16" FontAttributes="Bold"/>
                        </VerticalStackLayout>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>